{% extends "dashboard/base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<h3 class="mb-4">ðŸ“Š VisÃ£o Geral dos Sinistros</h3>

<!-- ðŸ”¢ CARDS -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card shadow-sm text-center">
      <div class="card-body">
        <h6>Total de Sinistros</h6>
        <h3>{{ data.cards.total }}</h3>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm text-center">
      <div class="card-body">
        <h6>Hoje</h6>
        <h3>{{ data.cards.today }}</h3>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm text-center">
      <div class="card-body">
        <h6>No MÃªs</h6>
        <h3>{{ data.cards.month }}</h3>
      </div>
    </div>
  </div>
</div>

<!-- ðŸ“Š GRÃFICOS -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card shadow-sm p-3">
      <canvas id="chartCategorias"></canvas>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card shadow-sm p-3">
      <canvas id="chartTimeline"></canvas>
    </div>
  </div>
</div>

<!-- ðŸ—ºï¸ MAPA + LISTA -->
<div class="row">
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-header fw-bold">Sinistros</div>
      <ul class="list-group list-group-flush" id="sinistro-list"></ul>
    </div>
  </div>

  <div class="col-md-9">
    <div id="map" style="height: 500px; border-radius: 8px;" class="shadow-sm"></div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
/* ðŸ“Š GRÃFICOS */
const categorias = {{ data.categorias|safe }};
const timeline = {{ data.timeline|safe }};

new Chart(document.getElementById("chartCategorias"), {
  type: "bar",
  data: {
    labels: categorias.map(c => c.label),
    datasets: [{
      label: "Sinistros",
      data: categorias.map(c => c.value)
    }]
  }
});

new Chart(document.getElementById("chartTimeline"), {
  type: "line",
  data: {
    labels: timeline.map(t => t.date),
    datasets: [{
      label: "Sinistros por dia",
      data: timeline.map(t => t.value)
    }]
  }
});

/* ðŸ—ºï¸ MAPA */
const sinistros = {{ data.mapa|safe }};

if (sinistros.length > 0) {
  const map = L.map('map').setView(
    [sinistros[0].latitude, sinistros[0].longitude],
    13
  );

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const heat = [];

  sinistros.forEach(s => {
    L.marker([s.latitude, s.longitude])
      .addTo(map)
      .bindPopup(`
        <strong>Sinistro #${s.id}</strong><br>
        ${s.tipo}<br>
        ${s.endereco}<br>
        <a href="/sinistros/${s.id}/">Ver detalhes</a>
      `);

    heat.push([s.latitude, s.longitude, 0.7]);

    const li = document.createElement("li");
    li.className = "list-group-item list-group-item-action";
    li.innerHTML = `<strong>#${s.id}</strong><br><small>${s.tipo}</small>`;
    li.onclick = () => map.setView([s.latitude, s.longitude], 17);
    document.getElementById("sinistro-list").appendChild(li);
  });

  L.heatLayer(heat, { radius: 25 }).addTo(map);
}
</script>
{% endblock %}
