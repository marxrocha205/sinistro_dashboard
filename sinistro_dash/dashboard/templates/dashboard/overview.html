{% extends "dashboard/base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<h3 class="mb-4">VisÃ£o Geral</h3>

<!-- ðŸ”¢ CARDS -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card shadow-sm text-center">
      <div class="card-body">
        <h6>Total de Sinistros</h6>
        <h3>{{ data.cards.total|default:"0" }}</h3>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm text-center">
      <div class="card-body">
        <h6>Hoje</h6>
        <h3>{{ data.cards.today|default:"0" }}</h3>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm text-center">
      <div class="card-body">
        <h6>No MÃªs</h6>
        <h3>{{ data.cards.month|default:"0" }}</h3>
      </div>
    </div>
  </div>
</div>

<!-- ðŸ“Š GRÃFICOS -->
<div class="row mb-4">
  <div class="col-md-6">
    <canvas id="chartCategorias"></canvas>
  </div>
  <div class="col-md-6">
    <canvas id="chartTimeline"></canvas>
  </div>
</div>

<!-- ðŸ—ºï¸ MAPA + LISTA -->
<div class="row">
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-header fw-bold">
        Sinistros
      </div>
      <ul class="list-group list-group-flush" id="sinistro-list"></ul>
    </div>
  </div>

  <div class="col-md-9">
    <div id="map" style="height: 500px; border-radius: 8px;" class="shadow-sm"></div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ======================
   ðŸ“Š GRÃFICOS
====================== */
const categorias = {{ data.categorias|safe }};
const timeline = {{ data.timeline|safe }};

new Chart(document.getElementById("chartCategorias"), {
  type: "bar",
  data: {
    labels: categorias.map(c => c.label),
    datasets: [{
      label: "Sinistros",
      data: categorias.map(c => c.value),
    }]
  }
});

new Chart(document.getElementById("chartTimeline"), {
  type: "line",
  data: {
    labels: timeline.map(t => t.date),
    datasets: [{
      label: "Sinistros por dia",
      data: timeline.map(t => t.value),
    }]
  }
});

/* ======================
   ðŸ—ºï¸ MAPA + HEATMAP
====================== */
const sinistrosRaw = {{ data.mapa|safe }};

// âœ… sÃ³ os que tÃªm localizaÃ§Ã£o
const sinistros = sinistrosRaw.filter(
  s => s.latitude !== null && s.longitude !== null
);

const mapContainer = document.getElementById("map");
const list = document.getElementById("sinistro-list");

if (sinistros.length === 0) {
  mapContainer.innerHTML =
    "<p class='text-muted text-center mt-4'>Nenhum sinistro com localizaÃ§Ã£o</p>";
} else {

  const map = L.map('map').setView(
    [sinistros[0].latitude, sinistros[0].longitude],
    13
  );

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const heatPoints = [];

  sinistros.forEach(s => {
    const marker = L.marker([s.latitude, s.longitude]).addTo(map);

    marker.bindPopup(`
      <strong>Sinistro #${s.id}</strong><br>
      ${s.tipo}<br>
      ${s.endereco}<br>
      <a href="/sinistros/${s.id}/">Ver detalhes</a>
    `);

    heatPoints.push([s.latitude, s.longitude, 0.6]);

    const li = document.createElement("li");
    li.className = "list-group-item list-group-item-action";
    li.innerHTML = `
      <strong>#${s.id}</strong><br>
      <small>${s.tipo}</small>
    `;

    li.onclick = () => {
      map.setView([s.latitude, s.longitude], 17);
      marker.openPopup();
    };

    list.appendChild(li);
  });

  // ðŸ”¥ HEATMAP
  L.heatLayer(heatPoints, {
    radius: 25,
    blur: 15,
    maxZoom: 17
  }).addTo(map);
}
</script>
{% endblock %}
