{% extends "dashboard/base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h3 class="mb-4"> VisÃ£o Geral dos Sinistros</h3>

<!-- ðŸ”¢ CARDS -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card shadow-sm text-center">
      <div class="card-body">
        <h6>Total</h6>
        <h3>{{ data.cards.total }}</h3>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm text-center">
      <div class="card-body">
        <h6>Hoje</h6>
        <h3>{{ data.cards.today }}</h3>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm text-center">
      <div class="card-body">
        <h6>No mÃªs</h6>
        <h3>{{ data.cards.month }}</h3>
      </div>
    </div>
  </div>
</div>

<!-- ðŸ—ºï¸ MAPA + LISTA -->
<div class="row">
  <div class="col-md-3">

    <div class="card shadow-sm">
      <div class="card-header fw-bold">
         Sinistros
      </div>

      <ul class="list-group list-group-flush" id="sinistro-list"></ul>

      <!-- ðŸ“„ PAGINAÃ‡ÃƒO -->
      <div class="card-footer text-center">
        <nav>
          <ul class="pagination pagination-sm justify-content-center mb-0" id="sinistro-pagination"></ul>
        </nav>
      </div>
    </div>

  </div>

  <div class="col-md-9">
    <div id="map" style="height: 500px; border-radius: 8px;" class="shadow-sm"></div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
/* ======================
   DADOS
====================== */
const sinistros = {{ data.mapa|safe }};
const ITEMS_PER_PAGE = 7;

let currentPage = 1;
const totalPages = Math.ceil(sinistros.length / ITEMS_PER_PAGE);

const listEl = document.getElementById("sinistro-list");
const paginationEl = document.getElementById("sinistro-pagination");

/* ======================
   MAPA
====================== */
let map;

if (sinistros.length > 0) {
  map = L.map('map').setView(
    [sinistros[0].latitude, sinistros[0].longitude],
    13
  );

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  sinistros.forEach(s => {
    L.marker([s.latitude, s.longitude])
      .addTo(map)
      .bindPopup(`
        <strong>Sinistro #${s.id}</strong><br>
        ${s.tipo}<br>
        ${s.endereco}<br>
        <a href="/sinistros/${s.id}/">Ver detalhes</a>
      `);
  });
}

/* ======================
   LISTA + PAGINAÃ‡ÃƒO
====================== */
function renderList() {
  listEl.innerHTML = "";

  const start = (currentPage - 1) * ITEMS_PER_PAGE;
  const end = start + ITEMS_PER_PAGE;

  sinistros.slice(start, end).forEach(s => {
    const li = document.createElement("li");
    li.className = "list-group-item list-group-item-action";
    li.innerHTML = `
      <strong>#${s.id}</strong><br>
      <small>${s.tipo}</small>
    `;

    li.onclick = () => {
      map.setView([s.latitude, s.longitude], 17);
    };

    listEl.appendChild(li);
  });
}

function renderPagination() {
  paginationEl.innerHTML = "";

  for (let i = 1; i <= totalPages; i++) {
    const li = document.createElement("li");
    li.className = `page-item ${i === currentPage ? "active" : ""}`;

    li.innerHTML = `<a class="page-link" href="#">${i}</a>`;

    li.onclick = (e) => {
      e.preventDefault();
      currentPage = i;
      renderList();
      renderPagination();
    };

    paginationEl.appendChild(li);
  }
}

renderList();
renderPagination();
</script>
{% endblock %}
