{% extends "dashboard/base.html" %}
{% block title %}Detalhe do Sinistro{% endblock %}

{% block content %}

<h3 class="mb-3">
  ðŸš¨ Sinistro de {{ sinistro.tipo_principal }}
  <small class="text-muted">({{ sinistro.endereco }})</small>
</h3>

<div class="row mb-4">
  <div class="col-md-6">
    <p><strong>Data:</strong> {{ sinistro.data_hora }}</p>
    <p><strong>Ponto de referÃªncia:</strong> {{ sinistro.ponto_referencia|default:"â€”" }}</p>
    <p><strong>VÃ­tima fatal:</strong> {{ sinistro.houve_vitima_fatal|yesno:"Sim,NÃ£o" }}</p>
    <p><strong>UsuÃ¡rio:</strong> {{ sinistro.usuario.username }}</p>
  </div>

  <div class="col-md-6">
    <div id="map" style="height: 300px; border-radius: 8px;" class="shadow-sm"></div>
  </div>
</div>

<hr>

<h5>ðŸ‘¥ Envolvidos</h5>

{% for e in sinistro.envolvidos %}
<div class="card mb-3 shadow-sm">
  <div class="card-body">

    {% if e.tipo == "pedestre" %}
      <strong>ðŸš¶ Pedestre</strong>
      <p>Nome: {{ e.pedestre.nome }}</p>
      <p>CPF: {{ e.pedestre.cpf }}</p>

    {% else %}
      <strong>ðŸš— VeÃ­culo ({{ e.tipo|upper }})</strong>
      <p>Placa: {{ e.veiculo.placa }}</p>
      <p>Chassi: {{ e.veiculo.chassi|default:"â€”" }}</p>

      {% if e.veiculo.condutor %}
        <hr>
        <strong>ðŸ‘¤ Condutor</strong>
        <p>Nome: {{ e.veiculo.condutor.nome }}</p>
        <p>CPF: {{ e.veiculo.condutor.cpf }}</p>
        <p>
          CNH:
          {% if e.veiculo.condutor.possui_cnh %}
            Sim ({{ e.veiculo.condutor.numero_cnh }})
          {% else %}
            NÃ£o possui
          {% endif %}
        </p>
      {% endif %}
    {% endif %}

  </div>
</div>
{% empty %}
<p class="text-muted">Nenhum envolvido informado.</p>
{% endfor %}

<hr>

<h5>ðŸ“¸ Fotos</h5>

{% if sinistro.fotos %}
<div class="row">
  {% for foto in sinistro.fotos %}
  <div class="col-md-3 mb-3">
    <img src="{{ foto.url }}" class="img-fluid rounded shadow-sm">
  </div>
  {% endfor %}
</div>
{% else %}
<p class="text-muted">Nenhuma foto registrada.</p>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
{% if sinistro.latitude and sinistro.longitude %}
const map = L.map('map').setView(
  [{{ sinistro.latitude }}, {{ sinistro.longitude }}],
  16
);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

L.marker([{{ sinistro.latitude }}, {{ sinistro.longitude }}])
  .addTo(map)
  .bindPopup("Local do Sinistro")
  .openPopup();
{% else %}
document.getElementById("map").innerHTML =
  "<p class='text-muted text-center mt-4'>LocalizaÃ§Ã£o nÃ£o informada</p>";
{% endif %}
</script>
{% endblock %}
