{% extends "dashboard/base.html" %}
{% block title %}Detalhe do Sinistro{% endblock %}

{% block content %}

<h3 class="mb-4 page-title">
  Sinistro em {{ sinistro.endereco }}
</h3>

<div class="row mb-4">
  <div class="col-md-6 col-sm-12">
    <p><strong>Tipo principal:</strong> {{ sinistro.tipo_principal }}</p>
    <p><strong>Tipo secundário:</strong> {{ sinistro.tipo_secundario }}</p>
    <p><strong>Data:</strong> {{ sinistro.data_hora }}</p>
    <p><strong>Vítima fatal:</strong> {{ sinistro.houve_vitima_fatal|yesno:"Sim,Não" }}</p>

    {% if sinistro.usuario %}
      <p>
        <strong>Registrado por:</strong>
        {{ sinistro.usuario.username }} ({{ sinistro.usuario.perfil }})
      </p>
    {% endif %}
  </div>

  <div class="col-md-6 col-sm-12">
    <div id="map" style="height:300px" class="rounded shadow-sm"></div>
  </div>
</div>

<hr>

<h5 class="mb-3">
  Envolvidos ({{ sinistro.envolvidos|length }})
</h5>

{% for e in sinistro.envolvidos %}
  <div class="card mb-3 shadow-sm border-0">
    <div class="card-body">

      <div class="mb-2">
        <span class="badge bg-secondary">
          Envolvido {{ forloop.counter }}
        </span>

        {% if e.tipo == "pedestre" %}
          <span class="badge bg-info text-dark ms-2">Pedestre</span>
        {% else %}
          <span class="badge bg-warning text-dark ms-2">
            Veículo ({{ e.tipo|upper }})
          </span>
        {% endif %}
      </div>

      {% if e.tipo == "pedestre" %}
        <p><strong>Nome:</strong> {{ e.pedestre.nome }}</p>
        <p><strong>CPF:</strong> {{ e.pedestre.cpf }}</p>

      {% else %}
        <p><strong>Placa:</strong> {{ e.veiculo.placa }}</p>
        <p><strong>Chassi:</strong> {{ e.veiculo.chassi|default:"—" }}</p>

        {% if e.veiculo.descricao_outro %}
          <p><strong>Descrição:</strong> {{ e.veiculo.descricao_outro }}</p>
        {% endif %}

        {% if e.veiculo.condutor %}
          <hr>
          <p class="fw-bold mb-1">Condutor</p>
          <p><strong>Nome:</strong> {{ e.veiculo.condutor.nome }}</p>
          <p><strong>CPF:</strong> {{ e.veiculo.condutor.cpf }}</p>
          <p>
            <strong>CNH:</strong>
            {% if e.veiculo.condutor.possui_cnh %}
              Sim ({{ e.veiculo.condutor.numero_cnh }})
            {% else %}
              Não possui
            {% endif %}
          </p>
        {% endif %}
      {% endif %}

    </div>
  </div>
{% empty %}
  <p class="text-muted">Nenhum envolvido informado.</p>
{% endfor %}


<h5 class="mb-3">Fotos</h5>

{% if sinistro.fotos %}
  <div class="row">
    {% for f in sinistro.fotos %}
      <div class="col-md-3 col-sm-6 mb-3">
        <img src="{{ f.url }}" class="img-fluid rounded shadow-sm">
      </div>
    {% endfor %}
  </div>
{% else %}
  <p class="text-muted">Nenhuma foto registrada.</p>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
const map = L.map('map').setView(
  [{{ sinistro.latitude }}, {{ sinistro.longitude }}],
  16
);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
L.marker([{{ sinistro.latitude }}, {{ sinistro.longitude }}]).addTo(map);
</script>
{% endblock %}
